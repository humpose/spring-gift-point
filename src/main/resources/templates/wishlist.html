<!DOCTYPE html>
<html>
<head>
  <title>위시 리스트</title>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('jwtToken');
      if (!token) {
        alert('로그인이 필요합니다.');
        window.location.href = '/users/login';
      } else {
        fetchWishList(token);
      }

      function fetchWishList(token) {
        fetch('/api/wishes?page=0&size=10&sort=createdDate,desc', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (response.status === 200) {
            return response.json();
          } else if (response.status === 401) {
            alert('인증 실패: 토큰이 유효하지 않거나 만료되었습니다.');
            window.location.href = '/users/login';
          } else {
            throw new Error('위시리스트를 불러오는 데 실패했습니다.');
          }
        })
        .then(data => {
          const tableBody = document.querySelector('tbody');
          tableBody.innerHTML = '';
          data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.product.id}</td>
              <td>${item.product.name}</td>
              <td>${item.product.price}</td>
              <td><img src="${item.product.imageUrl}" alt="${item.product.name}" width="50"></td>
              <td>
                <form action="/api/wishes/${item.product.id}" method="post" class="remove-form">
                  <input type="hidden" name="_method" value="DELETE">
                  <button type="submit">삭제</button>
                </form>
              </td>
            `;
            tableBody.appendChild(row);
          });
          addRemoveFormListeners(token);
        })
        .catch(error => alert(error.message));
      }

      function addRemoveFormListeners(token) {
        document.querySelectorAll('.remove-form').forEach(form => {
          form.addEventListener('submit', function(event) {
            event.preventDefault();
            const action = form.getAttribute('action');

            fetch(action, {
              method: 'DELETE',
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            })
            .then(response => {
              if (response.status === 200) {
                fetchWishList(token);
              } else {
                throw new Error('삭제하는 데 실패했습니다.');
              }
            })
            .catch(error => alert(error.message));
          });
        });
      }

      document.querySelector('.btn-add-product').addEventListener('click', function(event) {
        event.preventDefault();
        fetch('/api/wishes/add', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (response.status === 200) {
            return response.text();
          } else {
            throw new Error('제품 추가 페이지를 불러오는 데 실패했습니다.');
          }
        })
        .then(html => {
          document.open();
          document.write(html);
          document.close();
        })
        .catch(error => alert(error.message));
      });
    });
  </script>
</head>
<body>
<h1>위시 리스트</h1>
<div>
  <a href="#" class="btn btn-primary btn-add-product">제품 추가</a>
</div>
<table>
  <thead>
  <tr>
    <th>ID</th>
    <th>이름</th>
    <th>가격</th>
    <th>이미지</th>
    <th>액션</th>
  </tr>
  </thead>
  <tbody>

  </tbody>
</table>
</body>
</html>